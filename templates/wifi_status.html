<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Connection Status</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WiFi Connection Status</h1>
        </div>
        
        <div class="content">
            {% if success %}
                <div class="status-card">
                    <div class="status-title">‚úÖ Successfully Connected!</div>
                    <div class="status-info">
                        <strong>Network:</strong> {{ status.ssid }}<br>
                        <strong>IP Address:</strong> {{ status.ip_address or 'N/A' }}<br>
                        <strong>Interface:</strong> {{ status.interface or 'N/A' }}
                    </div>
                </div>
                
                <div class="alert alert-success">
                    Your device is now connected to the WiFi network. Setup is complete!
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="window.location.href='/'" class="btn btn-secondary">Return to Setup</button>
                    <button onclick="window.location.reload()" class="btn btn-primary" style="margin-left: 10px;">Refresh Status</button>
                </div>
            {% elif connection_in_progress %}
                <div class="status-card" style="border-color: #ffa500;">
                    <div class="status-title">üîÑ Connection In Progress</div>
                    <div class="status-info">
                        {{ message or 'Attempting to connect to WiFi network...' }}
                    </div>
                </div>
                
                <div class="alert alert-info">
                    Please wait while we connect to your WiFi network. This may take a few moments.
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="window.location.href='/'" class="btn btn-secondary">Cancel and Return</button>
                    <button onclick="window.location.reload()" class="btn btn-primary" style="margin-left: 10px;">Refresh Status</button>
                </div>
            {% else %}
                <div class="status-card disconnected">
                    <div class="status-title">‚ùå Connection Failed</div>
                    <div class="status-info">
                        {{ message or 'Unable to connect to the WiFi network.' }}
                    </div>
                </div>
                
                <div class="alert alert-error">
                    The connection attempt was unsuccessful. Please check your network name and password, then try again.
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="window.location.href='/'" class="btn btn-primary">Try Again</button>
                    <button onclick="window.location.reload()" class="btn btn-secondary" style="margin-left: 10px;">Refresh Status</button>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Check connection status - handle natural reconnection flow
        let checkCount = 0;
        let hasSeenFailure = false;
        
        function checkConnectionStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(status => {
                    // If we're connected to a real network (not setup hotspot), show success
                    if (status.connected && status.ssid && !status.ssid.includes('SetupWiFi')) {
                        // If we previously saw a failure, reload to show success page
                        if (hasSeenFailure || checkCount > 3) {
                            window.location.reload();
                        }
                    } 
                    // If connection is in progress, keep checking frequently
                    else if (status.connection_in_progress) {
                        setTimeout(checkConnectionStatus, 3000);
                    }
                    // Normal case - keep checking
                    else {
                        hasSeenFailure = true;
                        if (checkCount < 20) { // Check for up to 60 seconds (20 * 3s)
                            setTimeout(checkConnectionStatus, 3000);
                        } else {
                            // After 60 seconds, check less frequently  
                            setTimeout(checkConnectionStatus, 10000);
                        }
                    }
                    checkCount++;
                })
                .catch(error => {
                    console.log('Status check failed - this is normal during hotspot transition:', error);
                    hasSeenFailure = true;
                    
                    // When hotspot goes down, we'll get fetch errors
                    // Keep trying - once WiFi connects, we should be able to reach server again
                    if (checkCount < 20) {
                        setTimeout(checkConnectionStatus, 3000);
                    } else {
                        setTimeout(checkConnectionStatus, 10000);
                    }
                    checkCount++;
                });
        }
        
        // Start checking connection status
        checkConnectionStatus();
    </script>
</body>
</html> 